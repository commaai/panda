import opendbc
import platform

CC = 'gcc'
system = platform.system()
mac_ver = platform.mac_ver()

# gcc installed by homebrew has version suffix (e.g. gcc-12) in order to be
# distinguishable from system one - which acts as a symlink to clang
# clang works on macOS 15 and greater but has issues on earlier macOS versions.
# see: https://github.com/commaai/openpilot/issues/35093
if system == 'Darwin' and mac_ver[0] and mac_ver[0] < '15':
  CC += '-13'

env = Environment(
  CC=CC,
  CFLAGS=[
    '-nostdlib',
    '-fno-builtin',
    '-std=gnu11',
    '-Wfatal-errors',
    '-Wno-pointer-to-int-cast',
    "-DLIB_PANDA",
  ],
  CPPPATH=[".", "../../", "../../board/", opendbc.INCLUDE_PATH],
)
if system == "Darwin":
  env.PrependENVPath('PATH', '/opt/homebrew/bin')

if GetOption('ubsan'):
  flags = [
    "-fsanitize=undefined",
    "-fno-sanitize-recover=undefined",
  ]
  env['CFLAGS'] += flags
  env['LINKFLAGS'] += flags

shared = [
  "./crypto/rsa.c",
  "./crypto/sha.c",
  "./board/can_comms.c",
  "./board/drivers/can_common.c",
  "./board/fake_stm.c",

  # "./board/libc.c",
  # "./board/crc.c",
  # "./board/early_init.c",
  # "./board/stm32h7/board.c",
  # "./board/boards/red.c",
  # "./board/critical.c",
  # "./board/drivers/led.c",
  # "./board/drivers/pwm.c",
  # "./board/drivers/gpio.c",
  # "./board/drivers/fake_siren.c",
  # "./board/stm32h7/lli2c.c",
  # "./board/stm32h7/clock.c",
  # "./board/drivers/clock_source.c",
  # "./board/stm32h7/sound.c",
  # "./board/stm32h7/llflash.c",
  # "./board/stm32h7/stm32h7_config.c",
  # "./board/drivers/registers.c",
  # "./board/drivers/interrupts.c",
  # "./board/provision.c",
  # "./board/stm32h7/peripherals.c",
  # "./board/stm32h7/llusb.c",
  # "./board/drivers/usb.c",
  # "./board/drivers/spi.c",
  # "./board/drivers/timers.c",
  # "./board/boards/cuatro.c",
  # "./board/boards/tres.c",
  # "./board/stm32h7/lladc.c",
  # "./board/stm32h7/llspi.c",
  # "./board/faults.c",
  # "./board/boards/unused_funcs.c",
  "./board/utils.c",
]

c = ["panda.c"] + ["../../" + s for s in shared]

objs = env.SharedObject(c)
libpanda = env.SharedLibrary("libpanda.so", objs)
